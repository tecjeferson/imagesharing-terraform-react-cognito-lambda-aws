"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.loadSharedConfigFiles = exports.ENV_CONFIG_PATH = exports.ENV_CREDENTIALS_PATH = void 0;
var tslib_1 = require("tslib");
var fs_1 = require("fs");
var os_1 = require("os");
var path_1 = require("path");
exports.ENV_CREDENTIALS_PATH = "AWS_SHARED_CREDENTIALS_FILE";
exports.ENV_CONFIG_PATH = "AWS_CONFIG_FILE";
var swallowError = function () { return ({}); };
function loadSharedConfigFiles(init) {
    if (init === void 0) { init = {}; }
    var _a = init.filepath, filepath = _a === void 0 ? process.env[exports.ENV_CREDENTIALS_PATH] || path_1.join(getHomeDir(), ".aws", "credentials") : _a, _b = init.configFilepath, configFilepath = _b === void 0 ? process.env[exports.ENV_CONFIG_PATH] || path_1.join(getHomeDir(), ".aws", "config") : _b;
    return Promise.all([
        slurpFile(configFilepath).then(parseIni).then(normalizeConfigFile).catch(swallowError),
        slurpFile(filepath).then(parseIni).catch(swallowError),
    ]).then(function (parsedFiles) {
        var _a = tslib_1.__read(parsedFiles, 2), configFile = _a[0], credentialsFile = _a[1];
        return {
            configFile: configFile,
            credentialsFile: credentialsFile,
        };
    });
}
exports.loadSharedConfigFiles = loadSharedConfigFiles;
var profileKeyRegex = /^profile\s(["'])?([^\1]+)\1$/;
function normalizeConfigFile(data) {
    var e_1, _a;
    var map = {};
    try {
        for (var _b = tslib_1.__values(Object.keys(data)), _c = _b.next(); !_c.done; _c = _b.next()) {
            var key = _c.value;
            var matches = void 0;
            if (key === "default") {
                map.default = data.default;
            }
            else if ((matches = profileKeyRegex.exec(key))) {
                // eslint-disable-next-line @typescript-eslint/no-unused-vars
                var _d = tslib_1.__read(matches, 3), _1 = _d[0], _2 = _d[1], normalizedKey = _d[2];
                if (normalizedKey) {
                    map[normalizedKey] = data[key];
                }
            }
        }
    }
    catch (e_1_1) { e_1 = { error: e_1_1 }; }
    finally {
        try {
            if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
        }
        finally { if (e_1) throw e_1.error; }
    }
    return map;
}
function parseIni(iniData) {
    var e_2, _a;
    var map = {};
    var currentSection;
    try {
        for (var _b = tslib_1.__values(iniData.split(/\r?\n/)), _c = _b.next(); !_c.done; _c = _b.next()) {
            var line = _c.value;
            line = line.split(/(^|\s)[;#]/)[0]; // remove comments
            var section = line.match(/^\s*\[([^\[\]]+)]\s*$/);
            if (section) {
                currentSection = section[1];
            }
            else if (currentSection) {
                var item = line.match(/^\s*(.+?)\s*=\s*(.+?)\s*$/);
                if (item) {
                    map[currentSection] = map[currentSection] || {};
                    map[currentSection][item[1]] = item[2];
                }
            }
        }
    }
    catch (e_2_1) { e_2 = { error: e_2_1 }; }
    finally {
        try {
            if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
        }
        finally { if (e_2) throw e_2.error; }
    }
    return map;
}
function slurpFile(path) {
    return new Promise(function (resolve, reject) {
        fs_1.readFile(path, "utf8", function (err, data) {
            if (err) {
                reject(err);
            }
            else {
                resolve(data);
            }
        });
    });
}
function getHomeDir() {
    var _a = process.env, HOME = _a.HOME, USERPROFILE = _a.USERPROFILE, HOMEPATH = _a.HOMEPATH, _b = _a.HOMEDRIVE, HOMEDRIVE = _b === void 0 ? "C:" + path_1.sep : _b;
    if (HOME)
        return HOME;
    if (USERPROFILE)
        return USERPROFILE;
    if (HOMEPATH)
        return "" + HOMEDRIVE + HOMEPATH;
    return os_1.homedir();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi9zcmMvIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEseUJBQThCO0FBQzlCLHlCQUE2QjtBQUM3Qiw2QkFBaUM7QUFFcEIsUUFBQSxvQkFBb0IsR0FBRyw2QkFBNkIsQ0FBQztBQUNyRCxRQUFBLGVBQWUsR0FBRyxpQkFBaUIsQ0FBQztBQStCakQsSUFBTSxZQUFZLEdBQUcsY0FBTSxPQUFBLENBQUMsRUFBRSxDQUFDLEVBQUosQ0FBSSxDQUFDO0FBRWhDLFNBQWdCLHFCQUFxQixDQUFDLElBQTJCO0lBQTNCLHFCQUFBLEVBQUEsU0FBMkI7SUFFN0QsSUFBQSxLQUVFLElBQUksU0FGbUYsRUFBekYsUUFBUSxtQkFBRyxPQUFPLENBQUMsR0FBRyxDQUFDLDRCQUFvQixDQUFDLElBQUksV0FBSSxDQUFDLFVBQVUsRUFBRSxFQUFFLE1BQU0sRUFBRSxhQUFhLENBQUMsS0FBQSxFQUN6RixLQUNFLElBQUksZUFEK0UsRUFBckYsY0FBYyxtQkFBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHVCQUFlLENBQUMsSUFBSSxXQUFJLENBQUMsVUFBVSxFQUFFLEVBQUUsTUFBTSxFQUFFLFFBQVEsQ0FBQyxLQUFBLENBQzlFO0lBRVQsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDO1FBQ2pCLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQztRQUN0RixTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUM7S0FDdkQsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLFdBQWlDO1FBQ2xDLElBQUEsS0FBQSxlQUFnQyxXQUFXLElBQUEsRUFBMUMsVUFBVSxRQUFBLEVBQUUsZUFBZSxRQUFlLENBQUM7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QUFDO0lBRTVFLElBQUksSUFBSTtRQUFFLE9BQU8sSUFBSSxDQUFDO0lBQ3RCLElBQUksV0FBVztRQUFFLE9BQU8sV0FBVyxDQUFDO0lBQ3BDLElBQUksUUFBUTtRQUFFLE9BQU8sS0FBRyxTQUFTLEdBQUcsUUFBVSxDQUFDO0lBRS9DLE9BQU8sWUFBTyxFQUFFLENBQUM7QUFDbkIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHJlYWRGaWxlIH0gZnJvbSBcImZzXCI7XG5pbXBvcnQgeyBob21lZGlyIH0gZnJvbSBcIm9zXCI7XG5pbXBvcnQgeyBqb2luLCBzZXAgfSBmcm9tIFwicGF0aFwiO1xuXG5leHBvcnQgY29uc3QgRU5WX0NSRURFTlRJQUxTX1BBVEggPSBcIkFXU19TSEFSRURfQ1JFREVOVElBTFNfRklMRVwiO1xuZXhwb3J0IGNvbnN0IEVOVl9DT05GSUdfUEFUSCA9IFwiQVdTX0NPTkZJR19GSUxFXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2hhcmVkQ29uZmlnSW5pdCB7XG4gIC8qKlxuICAgKiBUaGUgcGF0aCBhdCB3aGljaCB0byBsb2NhdGUgdGhlIGluaSBjcmVkZW50aWFscyBmaWxlLiBEZWZhdWx0cyB0byB0aGVcbiAgICogdmFsdWUgb2YgdGhlIGBBV1NfU0hBUkVEX0NSRURFTlRJQUxTX0ZJTEVgIGVudmlyb25tZW50IHZhcmlhYmxlIChpZlxuICAgKiBkZWZpbmVkKSBvciBgfi8uYXdzL2NyZWRlbnRpYWxzYCBvdGhlcndpc2UuXG4gICAqL1xuICBmaWxlcGF0aD86IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHBhdGggYXQgd2hpY2ggdG8gbG9jYXRlIHRoZSBpbmkgY29uZmlnIGZpbGUuIERlZmF1bHRzIHRvIHRoZSB2YWx1ZSBvZlxuICAgKiB0aGUgYEFXU19DT05GSUdfRklMRWAgZW52aXJvbm1lbnQgdmFyaWFibGUgKGlmIGRlZmluZWQpIG9yXG4gICAqIGB+Ly5hd3MvY29uZmlnYCBvdGhlcndpc2UuXG4gICAqL1xuICBjb25maWdGaWxlcGF0aD86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQcm9maWxlIHtcbiAgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBhcnNlZEluaURhdGEge1xuICBba2V5OiBzdHJpbmddOiBQcm9maWxlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNoYXJlZENvbmZpZ0ZpbGVzIHtcbiAgY3JlZGVudGlhbHNGaWxlOiBQYXJzZWRJbmlEYXRhO1xuICBjb25maWdGaWxlOiBQYXJzZWRJbmlEYXRhO1xufVxuXG5jb25zdCBzd2FsbG93RXJyb3IgPSAoKSA9PiAoe30pO1xuXG5leHBvcnQgZnVuY3Rpb24gbG9hZFNoYXJlZENvbmZpZ0ZpbGVzKGluaXQ6IFNoYXJlZENvbmZpZ0luaXQgPSB7fSk6IFByb21pc2U8U2hhcmVkQ29uZmlnRmlsZXM+IHtcbiAgY29uc3Qge1xuICAgIGZpbGVwYXRoID0gcHJvY2Vzcy5lbnZbRU5WX0NSRURFTlRJQUxTX1BBVEhdIHx8IGpvaW4oZ2V0SG9tZURpcigpLCBcIi5hd3NcIiwgXCJjcmVkZW50aWFsc1wiKSxcbiAgICBjb25maWdGaWxlcGF0aCA9IHByb2Nlc3MuZW52W0VOVl9DT05GSUdfUEFUSF0gfHwgam9pbihnZXRIb21lRGlyKCksIFwiLmF3c1wiLCBcImNvbmZpZ1wiKSxcbiAgfSA9IGluaXQ7XG5cbiAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICBzbHVycEZpbGUoY29uZmlnRmlsZXBhdGgpLnRoZW4ocGFyc2VJbmkpLnRoZW4obm9ybWFsaXplQ29uZmlnRmlsZSkuY2F0Y2goc3dhbGxvd0Vycm9yKSxcbiAgICBzbHVycEZpbGUoZmlsZXBhdGgpLnRoZW4ocGFyc2VJbmkpLmNhdGNoKHN3YWxsb3dFcnJvciksXG4gIF0pLnRoZW4oKHBhcnNlZEZpbGVzOiBBcnJheTxQYXJzZWRJbmlEYXRhPikgPT4ge1xuICAgIGNvbnN0IFtjb25maWdGaWxlLCBjcmVkZW50aWFsc0ZpbGVdID0gcGFyc2VkRmlsZXM7XG4gICAgcmV0dXJuIHtcbiAgICAgIGNvbmZpZ0ZpbGUsXG4gICAgICBjcmVkZW50aWFsc0ZpbGUsXG4gICAgfTtcbiAgfSk7XG59XG5cbmNvbnN0IHByb2ZpbGVLZXlSZWdleCA9IC9ecHJvZmlsZVxccyhbXCInXSk/KFteXFwxXSspXFwxJC87XG5mdW5jdGlvbiBub3JtYWxpemVDb25maWdGaWxlKGRhdGE6IFBhcnNlZEluaURhdGEpOiBQYXJzZWRJbmlEYXRhIHtcbiAgY29uc3QgbWFwOiBQYXJzZWRJbmlEYXRhID0ge307XG4gIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKGRhdGEpKSB7XG4gICAgbGV0IG1hdGNoZXM6IEFycmF5PHN0cmluZz4gfCBudWxsO1xuICAgIGlmIChrZXkgPT09IFwiZGVmYXVsdFwiKSB7XG4gICAgICBtYXAuZGVmYXVsdCA9IGRhdGEuZGVmYXVsdDtcbiAgICB9IGVsc2UgaWYgKChtYXRjaGVzID0gcHJvZmlsZUtleVJlZ2V4LmV4ZWMoa2V5KSkpIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnNcbiAgICAgIGNvbnN0IFtfMSwgXzIsIG5vcm1hbGl6ZWRLZXldID0gbWF0Y2hlcztcbiAgICAgIGlmIChub3JtYWxpemVkS2V5KSB7XG4gICAgICAgIG1hcFtub3JtYWxpemVkS2V5XSA9IGRhdGFba2V5XTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gbWFwO1xufVxuXG5mdW5jdGlvbiBwYXJzZUluaShpbmlEYXRhOiBzdHJpbmcpOiBQYXJzZWRJbmlEYXRhIHtcbiAgY29uc3QgbWFwOiBQYXJzZWRJbmlEYXRhID0ge307XG4gIGxldCBjdXJyZW50U2VjdGlvbjogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBmb3IgKGxldCBsaW5lIG9mIGluaURhdGEuc3BsaXQoL1xccj9cXG4vKSkge1xuICAgIGxpbmUgPSBsaW5lLnNwbGl0KC8oXnxcXHMpWzsjXS8pWzBdOyAvLyByZW1vdmUgY29tbWVudHNcbiAgICBjb25zdCBzZWN0aW9uID0gbGluZS5tYXRjaCgvXlxccypcXFsoW15cXFtcXF1dKyldXFxzKiQvKTtcbiAgICBpZiAoc2VjdGlvbikge1xuICAgICAgY3VycmVudFNlY3Rpb24gPSBzZWN0aW9uWzFdO1xuICAgIH0gZWxzZSBpZiAoY3VycmVudFNlY3Rpb24pIHtcbiAgICAgIGNvbnN0IGl0ZW0gPSBsaW5lLm1hdGNoKC9eXFxzKiguKz8pXFxzKj1cXHMqKC4rPylcXHMqJC8pO1xuICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgbWFwW2N1cnJlbnRTZWN0aW9uXSA9IG1hcFtjdXJyZW50U2VjdGlvbl0gfHwge307XG4gICAgICAgIG1hcFtjdXJyZW50U2VjdGlvbl1baXRlbVsxXV0gPSBpdGVtWzJdO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBtYXA7XG59XG5cbmZ1bmN0aW9uIHNsdXJwRmlsZShwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHJlYWRGaWxlKHBhdGgsIFwidXRmOFwiLCAoZXJyLCBkYXRhKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzb2x2ZShkYXRhKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGdldEhvbWVEaXIoKTogc3RyaW5nIHtcbiAgY29uc3QgeyBIT01FLCBVU0VSUFJPRklMRSwgSE9NRVBBVEgsIEhPTUVEUklWRSA9IGBDOiR7c2VwfWAgfSA9IHByb2Nlc3MuZW52O1xuXG4gIGlmIChIT01FKSByZXR1cm4gSE9NRTtcbiAgaWYgKFVTRVJQUk9GSUxFKSByZXR1cm4gVVNFUlBST0ZJTEU7XG4gIGlmIChIT01FUEFUSCkgcmV0dXJuIGAke0hPTUVEUklWRX0ke0hPTUVQQVRIfWA7XG5cbiAgcmV0dXJuIGhvbWVkaXIoKTtcbn1cbiJdfQ==